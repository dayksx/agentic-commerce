{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///home/dayan/Workspace/ethglobal-server-agent/ui/app/api/a2a/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createWalletClient, http } from 'viem';\nimport { privateKeyToAccount } from 'viem/accounts';\nimport { baseSepolia } from 'viem/chains';\nimport { wrapFetchWithPayment, decodeXPaymentResponse } from 'x402-fetch';\n\nconst PRIVATE_KEY = process.env.PRIVATE_KEY;\nconst MCP_ENDPOINT = process.env.MCP_ENDPOINT || 'http://0.0.0.0:8001/mcp';\n\n// Create wallet client with base-sepolia chain configuration\nlet walletClient: ReturnType<typeof createWalletClient> | null = null;\nlet fetchWithPayment: typeof fetch | null = null;\n\n// Initialize wallet client and payment wrapper\nif (PRIVATE_KEY) {\n  try {\n    const account = privateKeyToAccount(PRIVATE_KEY as `0x${string}`);\n    walletClient = createWalletClient({\n      account,\n      transport: http(),\n      chain: baseSepolia,\n    });\n    // Type assertion needed due to version mismatch between x402-fetch and viem types\n    fetchWithPayment = wrapFetchWithPayment(fetch, walletClient as any);\n  } catch (error) {\n    console.error('Failed to initialize wallet client:', error);\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { message, conversationId } = body;\n\n    if (!message) {\n      return NextResponse.json(\n        { error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n\n    if (!PRIVATE_KEY) {\n      return NextResponse.json(\n        { error: 'PRIVATE_KEY environment variable is not set' },\n        { status: 500 }\n      );\n    }\n\n    if (!fetchWithPayment) {\n      return NextResponse.json(\n        { error: 'Failed to initialize payment client' },\n        { status: 500 }\n      );\n    }\n\n    // Call MCP server with x402 payment handling\n    const response = await fetchWithPayment(MCP_ENDPOINT, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json, text/event-stream',\n      },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'tools/call',\n        params: {\n          name: 'query_agent_registry',\n          arguments: {\n            prompt: message,\n          },\n        },\n      }),\n    });\n\n    if (response.status === 402) {\n      console.log('⚠️ Still got 402 - payment flow may have failed');\n      const errorBody = await response.json();\n      return NextResponse.json(\n        { \n          error: 'Payment required',\n          details: errorBody,\n          message: 'Payment processing failed. Please try again.'\n        },\n        { status: 402 }\n      );\n    }\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      return NextResponse.json(\n        { \n          error: 'MCP server error',\n          details: errorBody,\n          message: 'Failed to communicate with MCP server.'\n        },\n        { status: response.status }\n      );\n    }\n\n    const data = await response.json();\n    \n    // Extract payment response if available\n    const paymentResponseHeader = response.headers.get('x-payment-response');\n    let paymentResponse = null;\n    if (paymentResponseHeader) {\n      try {\n        paymentResponse = decodeXPaymentResponse(paymentResponseHeader);\n      } catch (error) {\n        console.warn('Failed to decode payment response:', error);\n      }\n    }\n\n    // Extract the result from the MCP response\n    let resultMessage = 'I received your message.';\n    if (data.result?.content) {\n      // Handle array of content items\n      if (Array.isArray(data.result.content)) {\n        resultMessage = data.result.content\n          .map((item: any) => item.text || JSON.stringify(item))\n          .join('\\n');\n      } else if (typeof data.result.content === 'string') {\n        resultMessage = data.result.content;\n      }\n    } else if (data.result?.structuredContent?.response) {\n      resultMessage = data.result.structuredContent.response;\n    } else if (data.error) {\n      resultMessage = `Error: ${data.error.message || JSON.stringify(data.error)}`;\n    }\n\n    return NextResponse.json({\n      message: resultMessage,\n      conversationId: conversationId || `conv_${Date.now()}`,\n      timestamp: new Date().toISOString(),\n      paymentResponse,\n    });\n  } catch (error) {\n    console.error('Error in A2A chatbot:', error);\n    return NextResponse.json(\n      { error: 'Failed to process chat message', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: Request) {\n  return NextResponse.json({\n    service: 'A2A Chatbot',\n    status: 'active',\n    endpoint: '/api/a2a',\n    methods: ['POST'],\n  });\n}\n\n"],"names":[],"mappings":"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"}}]
}